<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–∞—Ç—Ä–∏—Ü–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π</title>
  <style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --primary-light: #dbeafe;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --red-500: #ef4444;
      --border-radius: 0.5rem;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.5;
      color: var(--gray-800);
      background-color: #fff;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    h1 {
      font-size: 1.875rem;
      font-weight: 700;
      color: var(--primary);
      text-align: center;
      margin-bottom: 2rem;
    }

    h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }

    /* –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã */
    .card {
      background-color: #fff;
      border-radius: var(--border-radius);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--gray-200);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--gray-700);
    }

    .input, .textarea, .select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .input:focus, .textarea:focus, .select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      font-weight: 500;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 0.875rem;
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
    }

    .btn-outline:hover {
      background-color: var(--gray-100);
    }

    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    .flex {
      display: flex;
    }

    .flex-col {
      flex-direction: column;
    }

    .items-center {
      align-items: center;
    }

    .justify-between {
      justify-content: space-between;
    }

    .gap-2 {
      gap: 0.5rem;
    }

    .w-full {
      width: 100%;
    }

    .mt-2 {
      margin-top: 0.5rem;
    }

    .mt-4 {
      margin-top: 1rem;
    }

    .mb-2 {
      margin-bottom: 0.5rem;
    }

    .mb-4 {
      margin-bottom: 1rem;
    }

    .ml-2 {
      margin-left: 0.5rem;
    }

    .mr-2 {
      margin-right: 0.5rem;
    }

    .p-2 {
      padding: 0.5rem;
    }

    .p-4 {
      padding: 1rem;
    }

    .rounded {
      border-radius: var(--border-radius);
    }

    .border {
      border: 1px solid var(--gray-200);
    }

    .bg-blue-50 {
      background-color: var(--primary-light);
    }

    .text-sm {
      font-size: 0.875rem;
    }

    .text-xs {
      font-size: 0.75rem;
    }

    .text-gray-500 {
      color: var(--gray-500);
    }

    .text-blue-700 {
      color: var(--primary-dark);
    }

    .font-medium {
      font-weight: 500;
    }

    .font-semibold {
      font-weight: 600;
    }

    /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .competency-tag {
      display: inline-flex;
      align-items: center;
      background-color: var(--primary-light);
      padding: 0.25rem 0.5rem;
      border-radius: var(--border-radius);
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .competency-tag button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--red-500);
      margin-left: 0.25rem;
    }

    .matrix-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .matrix-table th, .matrix-table td {
      border: 1px solid var(--gray-300);
      padding: 0.5rem;
    }

    .matrix-table th {
      background-color: var(--gray-100);
      text-align: left;
    }

    .matrix-table tr.header-row {
      background-color: var(--primary-light);
    }

    .matrix-table input[type="number"] {
      width: 3rem;
      text-align: center;
      padding: 0.25rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.25rem;
    }

    .actions {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
    }

    .scroll-area {
      max-height: calc(100vh - 300px);
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .alert {
      padding: 1rem;
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
      background-color: var(--primary-light);
      color: var(--primary-dark);
      border: 1px solid var(--primary);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>–ú–∞—Ç—Ä–∏—Ü–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π</h1>

    <div id="no-data-alert" class="alert" style="display: none;">
      –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —á–µ–∫-–ª–∏—Å—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="checklist.html">—Å–æ–∑–¥–∞–π—Ç–µ —á–µ–∫-–ª–∏—Å—Ç</a> —Å–Ω–∞—á–∞–ª–∞.
    </div>

    <div class="card">
      <h2>–ú–∞—Ç—Ä–∏—Ü–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π: <span id="matrix-job-title"></span></h2>
      <div class="form-group">
        <label for="new-competency">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—é</label>
        <div class="flex gap-2">
          <input type="text" id="new-competency" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏" style="flex: 1;">
          <button class="btn btn-primary" onclick="addCompetency()">
            <span class="mr-2">+</span> –î–æ–±–∞–≤–∏—Ç—å
          </button>
        </div>
      </div>
      <div id="competencies-container" class="mt-4">
        <!-- –ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
      </div>
    </div>

    <div id="matrix-container" class="scroll-area">
      <!-- –ú–∞—Ç—Ä–∏—Ü–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
    </div>

    <div class="actions">
      <button class="btn btn-outline" onclick="goToChecklist()">
        <span class="mr-2">‚Üê</span> –ù–∞–∑–∞–¥ –∫ —á–µ–∫-–ª–∏—Å—Ç—É
      </button>
      <button class="btn btn-primary" onclick="saveMatrix()">
        <span class="mr-2">üíæ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ç—Ä–∏—Ü—É –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π
      </button>
    </div>
  </div>

  <script>
    // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
    let jobTitle = '';
    let groups = [];
    let competencies = [];
    let ratings = {};

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–∞—Ç—Ä–∏—Ü—ã –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π
    function addCompetency() {
      const input = document.getElementById('new-competency');
      const value = input.value.trim();

      if (value) {
        competencies.push(value);
        input.value = '';
        renderCompetencies();
        generateMatrix();
      }
    }

    function removeCompetency(index) {
      competencies.splice(index, 1);
      renderCompetencies();
      generateMatrix();
    }

    function renderCompetencies() {
      const container = document.getElementById('competencies-container');

      if (!container) return;

      container.innerHTML = '';

      if (competencies.length === 0) return;

      competencies.forEach((comp, index) => {
        const tag = document.createElement('span');
        tag.className = 'competency-tag';
        tag.innerHTML = `
          ${comp}
          <button onclick="removeCompetency(${index})">√ó</button>
        `;
        container.appendChild(tag);
      });
    }

    function generateMatrix() {
      const container = document.getElementById('matrix-container');

      if (!container  {
      const container = document.getElementById('matrix-container');

      if (!container) return;

      container.innerHTML = '';

      if (competencies.length === 0) {
        container.innerHTML = `
          <div class="card">
            <div class="text-center text-gray-500 p-4">
              –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ç—Ä–∏—Ü—ã
            </div>
          </div>
        `;
        return;
      }

      groups.forEach(group => {
        if (group.processes.length === 0) return;

        const groupCard = document.createElement('div');
        groupCard.className = 'card';

        groupCard.innerHTML = `
          <h3>${group.name}</h3>
          <table class="matrix-table">
            <thead>
              <tr>
                <th>–ü—Ä–æ—Ü–µ—Å—Å / –ö—Ä–∏—Ç–µ—Ä–∏–π</th>
                ${competencies.map(comp => `<th>${comp}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${generateMatrixRows(group)}
            </tbody>
          </table>
        `;

        container.appendChild(groupCard);
      });
    }

    function generateMatrixRows(group) {
      let rows = '';

      group.processes.forEach(process => {
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞
        rows += `
          <tr class="header-row">
            <td colspan="${competencies.length + 1}" class="font-medium">${process.name}</td>
          </tr>
        `;

        // –°—Ç—Ä–æ–∫–∏ –¥–ª—è –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
        const criteria = process.criteria.split(';').filter(c => c.trim());
        criteria.forEach((criterion, critIdx) => {
          rows += `
            <tr>
              <td class="pl-6 text-sm">${criterion.trim()}</td>
              ${competencies.map((_, compIndex) => `
                <td>
                  <input
                    type="number"
                    min="0"
                    max="10"
                    value="${getRating(group.id, `${process.id}-crit-${critIdx}`, compIndex)}"
                    onchange="updateRating('${group.id}', '${process.id}-crit-${critIdx}', ${compIndex}, this.value)"
                  >
                </td>
              `).join('')}
            </tr>
          `;
        });

        // –°—Ç—Ä–æ–∫–∏ –¥–ª—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤
        if (process.incidents.length > 0) {
          rows += `
            <tr>
              <td colspan="${competencies.length + 1}" class="pl-6 text-sm font-medium text-blue-700">
                –û–±—Ä–∞–±–æ—Ç–∫–∞ —à—Ç–∞—Ç–Ω—ã—Ö –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤:
              </td>
            </tr>
          `;

          process.incidents.forEach((incident, incIdx) => {
            rows += `
              <tr>
                <td class="pl-8 text-sm">
                  <div class="font-medium">${incident.description}</div>
                  <div class="mt-2 text-xs text-gray-500">–†–µ—à–µ–Ω–∏–µ: ${incident.solution}</div>
                </td>
                ${competencies.map((_, compIndex) => `
                  <td>
                    <input
                      type="number"
                      min="0"
                      max="10"
                      value="${getRating(group.id, `${process.id}-inc-${incIdx}`, compIndex)}"
                      onchange="updateRating('${group.id}', '${process.id}-inc-${incIdx}', ${compIndex}, this.value)"
                    >
                  </td>
                `).join('')}
              </tr>
            `;
          });
        }
      });

      return rows;
    }

    function updateRating(groupId, itemId, competencyIndex, value) {
      const numValue = Math.min(10, Math.max(0, parseInt(value) || 0));

      if (!ratings[groupId]) {
        ratings[groupId] = {};
      }

      if (!ratings[groupId][itemId]) {
        ratings[groupId][itemId] = {};
      }

      ratings[groupId][itemId][competencyIndex] = numValue;
    }

    function getRating(groupId, itemId, competencyIndex) {
      if (!ratings[groupId] || !ratings[groupId][itemId] || ratings[groupId][itemId][competencyIndex] === undefined) {
        return 0;
      }

      return ratings[groupId][itemId][competencyIndex];
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    function saveMatrix() {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
      const data = {
        jobTitle,
        groups,
        competencies,
        ratings,
        timestamp: new Date().toISOString()
      };

      localStorage.setItem('competencyMatrix', JSON.stringify(data));
      alert('–ú–∞—Ç—Ä–∏—Ü–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
    }

    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —á–µ–∫-–ª–∏—Å—Ç—É
    function goToChecklist() {
      window.location.href = 'checklist.html';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ–∫-–ª–∏—Å—Ç–∞
      const savedChecklist = localStorage.getItem('checklist');
      if (savedChecklist) {
        try {
          const data = JSON.parse(savedChecklist);
          jobTitle = data.jobTitle || '';
          groups = data.groups || [];

          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
          document.getElementById('matrix-job-title').textContent = jobTitle;
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —á–µ–∫-–ª–∏—Å—Ç–∞:', e);
          document.getElementById('no-data-alert').style.display = 'block';
          return;
        }
      } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö —á–µ–∫-–ª–∏—Å—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        document.getElementById('no-data-alert').style.display = 'block';
        return;
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –º–∞—Ç—Ä–∏—Ü—É, –µ—Å–ª–∏ –µ—Å—Ç—å
      const savedMatrix = localStorage.getItem('competencyMatrix');
      if (savedMatrix) {
        try {
          const data = JSON.parse(savedMatrix);
          competencies = data.competencies || [];
          ratings = data.ratings || {};

          renderCompetencies();
          generateMatrix();
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –º–∞—Ç—Ä–∏—Ü—ã:', e);
        }
      }

      // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –º–∞—Ç—Ä–∏—Ü—ã, –ø—Ä–æ—Å—Ç–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—É—Å—Ç—É—é
      if (competencies.length === 0) {
        generateMatrix();
      }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>